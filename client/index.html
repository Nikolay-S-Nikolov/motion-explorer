<!DOCTYPE html>
<html>

<head>
  <title>Motion Explorer</title>
  <style>
    canvas {
      border: 1px solid black;
    }

    #quiz,
    #desc {
      margin: 10px;
    }

    button {
      margin: 5px;
    }

    /* съобщение */
    #messageBubble {
      position: absolute;
      background: #fff;
      border: 2px solid #333;
      border-radius: 10px;
      padding: 10px 15px;
      max-width: 200px;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
      font-family: sans-serif;
      font-size: 14px;
      z-index: 1000;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    #messageBubble::after {
      content: "";
      position: absolute;
      bottom: -10px;
      left: 20px;
      border-width: 10px;
      border-style: solid;
      border-color: #fff transparent transparent transparent;
    }

    #messageTimer {
      height: 5px;
      background: #4caf50;
      margin-top: 5px;
      border-radius: 2px;
      transition: width 0.1s linear;
    }
  </style>
</head>

<body>
  <div id="menu"></div>
  <div id="desc"></div>
  <img id="figure" style="max-width: 200px;">
  <canvas id="canvas" width="400" height="200"></canvas>
  <div id="quiz"></div>
  <div id="messageBubble" style="display: none;">
    <div id="messageText"></div>
    <div id="messageTimer"></div>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let x = 50, y = 100, angle = 0;
    let animationId = null;

    // Зареждане на движения
    fetch('http://localhost:3000/api/movements')
      .then(res => res.json())
      .then(data => {
        const menu = document.getElementById('menu');
        data.forEach(m => {
          const btn = document.createElement('button');
          btn.textContent = m.id;
          btn.onclick = () => loadMovement(m.id);
          menu.appendChild(btn);
        });
        loadMovement(1); // Зареди първото
      })
      .catch(err => console.error('Error loading movements:', err));

    // Зареждане на движение
    function loadMovement(id) {
      fetch(`http://localhost:3000/api/movements/${id}`)
        .then(res => res.json())
        .then(m => {
          document.getElementById('desc').textContent = m.desc;
          document.getElementById('figure').src = `http://localhost:3000/${m.figure}`;
          startAnimation(m.type);
          showQuiz(m.id, m.type);
        });
    }

    // Анимация
    function startAnimation(type) {
      if (animationId) {
        cancelAnimationFrame(animationId);
      }
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        if (type === 'Праволинейно') {
          x = (x + 2) % 400;
          ctx.moveTo(x, y);
          ctx.lineTo(x + 20, y); // Стрелка
          ctx.stroke();
        } else if (type === 'Криволинейно') {
          x = (x + 2) % 400; y = 100 + Math.sin(x / 20) * 50;
          ctx.arc(x, y, 10, 0, Math.PI * 2); // Зигзаг
        } else if (type === 'Въртене') {
          angle += 0.05; x = 200 + Math.cos(angle) * 50; y = 100 + Math.sin(angle) * 50;
          ctx.arc(x, y, 10, 0, Math.PI * 2); // Кръг
        } else if (type === 'Трептене') {
          x = 200 + Math.sin(angle) * 100; angle += 0.1;
          ctx.arc(x, y, 10, 0, Math.PI * 2); // Люлеене
        }
        ctx.fill();
        animationId = requestAnimationFrame(() => animate());
      }
      animate();
    }

    // Интерактивност: влачене
    canvas.addEventListener('mousemove', (e) => {
      if (e.buttons === 1) { // Ако влачи
        x = e.offsetX; y = e.offsetY;
        const desc = document.getElementById('desc');
        if (!desc.textContent.includes('(Влачиш обекта!)')) {
          desc.textContent += ' (Влачиш обекта!)';
        }
      }
    });

    // Квиз (игра)
    function showQuiz(id, correctAnswer) {
      const quizDiv = document.getElementById('quiz');
      quizDiv.innerHTML = `
        <p>Какво е това движение?</p>
        <button onclick="submitAnswer(${id}, 'Праволинейно')">Праволинейно</button>
        <button onclick="submitAnswer(${id}, 'Криволинейно')">Криволинейно</button>
        <button onclick="submitAnswer(${id}, 'Въртене')">Въртене</button>
        <button onclick="submitAnswer(${id}, 'Трептене')">Трептене</button>
      `;
    }

    function submitAnswer(questionId, answer) {
      fetch('http://localhost:3000/api/quiz', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ questionId, answer })
      })
        .then(res => res.json())
        .then(data => {
          showMessageBubble(data.message, data.correct);
        });
    }

    function showMessageBubble(message, isCorrect) {
      const bubble = document.getElementById('messageBubble');
      const text = document.getElementById('messageText');
      const timer = document.getElementById('messageTimer');

      text.textContent = message;
      bubble.style.display = 'block';
      bubble.style.opacity = '1';
      bubble.style.borderColor = isCorrect ? '#4caf50' : '#f44336';
      timer.style.background = isCorrect ? '#4caf50' : '#f44336';

      // позиционирай над quiz бутона
      const quizDiv = document.getElementById('quiz');
      const rect = quizDiv.getBoundingClientRect();
      bubble.style.top = `${rect.top - 60}px`;
      bubble.style.left = `${rect.left + 20}px`;

      let duration = 5000; // 15 секунди
      let start = Date.now();

      function updateTimer() {
        let elapsed = Date.now() - start;
        let percent = Math.max(0, 100 - (elapsed / duration) * 100);
        timer.style.width = `${percent}%`;

        if (elapsed < duration) {
          requestAnimationFrame(updateTimer);
        } else {
          bubble.style.opacity = '0';
          setTimeout(() => bubble.style.display = 'none', 300);
        }
      }

      updateTimer();
    }

  </script>
</body>

</html>