<!DOCTYPE html>
<html>

<head>
  <title>Motion Explorer</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id="menu"></div>
  <div id="desc"></div>
  <img id="figure" style="max-width: 200px;">
  <canvas id="canvas" width="400" height="200"></canvas>
  <div id="quiz"></div>
  <div id="messageBubble" style="display: none;">
    <div id="messageText"></div>
    <div id="messageTimer"></div>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let x = 50, y = 100, angle = 0;
    let animationId = null;
    let currentQuestionIndex = 0;
    let movementsData = [];
    let isAnswering = false;

    // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏—è
    fetch('http://localhost:3000/api/movements')
      .then(res => res.json())
      .then(data => {
        movementsData = data;
        // console.log(movementsData[currentQuestionIndex])
        const menu = document.getElementById('menu');
        data.forEach((m, index) => {
          const btn = document.createElement('button');
          btn.textContent = index + 1;
          btn.id = `btn-${m.id}`;
          // btn.onclick = () => loadMovement(m.id);
          menu.appendChild(btn);
        });
        loadMovement(movementsData[currentQuestionIndex].id);
      })
      .catch(err => console.error('Error loading movements:', err));

    // –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏–µ
    function loadMovement(id) {
      fetch(`http://localhost:3000/api/movements/${id}`)
        .then(res => res.json())
        .then(m => {
          document.getElementById('desc').textContent = m.desc;
          document.getElementById('figure').src = `http://localhost:3000/${m.figure}`;
          startAnimation(m.type);
          showQuiz(m.id, m.type);
        });
    }

    // –ê–Ω–∏–º–∞—Ü–∏—è
    function startAnimation(type) {
      if (animationId) {
        cancelAnimationFrame(animationId);
      }
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        if (type === '–ü—Ä–∞–≤–æ–ª–∏–Ω–µ–π–Ω–æ') {
          x = (x + 2) % 400;
          ctx.moveTo(x, y);
          ctx.lineTo(x + 30, y); // –õ–∏–Ω–∏—è 30px
          ctx.stroke();
        } else if (type === '–ö—Ä–∏–≤–æ–ª–∏–Ω–µ–π–Ω–æ') {
          x = (x + 2) % 400; y = 100 + Math.sin(x / 20) * 50;
          ctx.arc(x, y, 10, 0, Math.PI * 2); // –ó–∏–≥–∑–∞–≥
        } else if (type === '–í—ä—Ä—Ç–µ–Ω–µ') {
          angle += 0.05; x = 200 + Math.cos(angle) * 50; y = 100 + Math.sin(angle) * 50;
          ctx.arc(x, y, 10, 0, Math.PI * 2); // –ö—Ä—ä–≥
        } else if (type === '–¢—Ä–µ–ø—Ç–µ–Ω–µ') {
          x = 200 + Math.sin(angle) * 100; angle += 0.1;
          ctx.arc(x, y, 10, 0, Math.PI * 2); // –õ—é–ª–µ–µ–Ω–µ
        }
        ctx.fill();
        animationId = requestAnimationFrame(() => animate());
      }
      animate();
    }

    // –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç: –≤–ª–∞—á–µ–Ω–µ
    canvas.addEventListener('mousemove', (e) => {
      if (e.buttons === 1) { // –ê–∫–æ –≤–ª–∞—á–∏
        x = e.offsetX; y = e.offsetY;
        const desc = document.getElementById('desc');
        if (!desc.textContent.includes('(–í–ª–∞—á–∏—à –æ–±–µ–∫—Ç–∞!)')) {
          desc.textContent += ' (–í–ª–∞—á–∏—à –æ–±–µ–∫—Ç–∞!)';
        }
      }
    });

    // –ö–≤–∏–∑ (–∏–≥—Ä–∞)
    function showQuiz(id, correctAnswer) {
      const quizDiv = document.getElementById('quiz');
      quizDiv.innerHTML = `
        <p>–ö–∞–∫–≤–æ –µ —Ç–æ–≤–∞ –¥–≤–∏–∂–µ–Ω–∏–µ?</p>
        <button onclick="submitAnswer(${id}, '–ü—Ä–∞–≤–æ–ª–∏–Ω–µ–π–Ω–æ')">–ü—Ä–∞–≤–æ–ª–∏–Ω–µ–π–Ω–æ</button>
        <button onclick="submitAnswer(${id}, '–ö—Ä–∏–≤–æ–ª–∏–Ω–µ–π–Ω–æ')">–ö—Ä–∏–≤–æ–ª–∏–Ω–µ–π–Ω–æ</button>
        <button onclick="submitAnswer(${id}, '–í—ä—Ä—Ç–µ–Ω–µ')">–í—ä—Ä—Ç–µ–Ω–µ</button>
        <button onclick="submitAnswer(${id}, '–¢—Ä–µ–ø—Ç–µ–Ω–µ')">–¢—Ä–µ–ø—Ç–µ–Ω–µ</button>
      `;
    }

    function submitAnswer(questionId, answer) {
      if (isAnswering) return;
      isAnswering = true;

      fetch('http://localhost:3000/api/quiz', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ questionId, answer })
      })
        .then(res => res.json())
        .then(data => {
          showMessageBubble(data.message, data.correct);

          if (data.correct) {
            const btn = document.getElementById(`btn-${questionId}`);
            if (btn) {
              btn.classList.add('correct');
            }
            currentQuestionIndex++;

            if (currentQuestionIndex < movementsData.length) {
              setTimeout(() => {
                isAnswering = false;
                loadMovement(movementsData[currentQuestionIndex].id);
              }, 3000); // –∑–∞–±–∞–≤—è–Ω–µ –∑–∞ –µ—Ñ–µ–∫—Ç
            } else {
              document.getElementById('quiz').innerHTML = '<p>–ë—Ä–∞–≤–æ! –û—Ç–≥–æ–≤–æ—Ä–∏ –Ω–∞ –≤—Å–∏—á–∫–∏ –≤—ä–ø—Ä–æ—Å–∏ üéâ</p>';
            }
          } else {
            isAnswering = false;
          }

        });
    }

    function showMessageBubble(message, isCorrect) {
      const bubble = document.getElementById('messageBubble');
      const text = document.getElementById('messageText');
      const timer = document.getElementById('messageTimer');

      text.textContent = message;
      bubble.style.display = 'block';
      bubble.style.opacity = '0.8';
      bubble.style.borderColor = isCorrect ? '#4caf50' : '#f44336';
      timer.style.background = isCorrect ? '#4caf50' : '#f44336';

      // –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–∞–π –Ω–∞–¥ quiz –±—É—Ç–æ–Ω–∞
      const quizDiv = document.getElementById('quiz');
      const rect = quizDiv.getBoundingClientRect();
      bubble.style.top = `${rect.top - 60}px`;
      bubble.style.left = `${rect.left + 20}px`;

      let duration = 3000; // 5 —Å–µ–∫—É–Ω–¥–∏
      let start = Date.now();

      function updateTimer() {
        let elapsed = Date.now() - start;
        let percent = Math.max(0, 100 - (elapsed / duration) * 100);
        timer.style.width = `${percent}%`;

        if (elapsed < duration) {
          requestAnimationFrame(updateTimer);
        } else {
          bubble.style.opacity = '0';
          setTimeout(() => bubble.style.display = 'none', 300);
        }
      }

      updateTimer();
    }

  </script>
</body>

</html>